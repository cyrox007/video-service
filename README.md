# Video Service
## Requirements
* Python 3.10+
* PostgreSQL15
* Redis
* FFmpeg
## Что необходимо знать
### База данных
Я впервые использовал PostgreSQL для проекта. Известные мне ранее методы настройки БД не подошли по какой-то неведомой мне причине. Но на всякий случай я оставлю инструкцию для запуска двумя методами. 

Для работы сайта потребуется установленный в системе PostgreSQL. 

Эти команды для Linux Ubuntu:
``` bash 
sudo -iu postgres psql -c "alter user postgres with password 'postgres';"
sudo -iu postgres psql -c "create database red;"
```
Первая обновит пароль для пользователя postgres, вторая создаст базу данных с именем red.

Аналогично для Mac OS: 
``` bash 
psql -U postgres -c "alter user postgres with password 'postgres';"
psql -U postgres -c "create database red;"
```

В случае чего можно, можно войти в консоль PGSQL и вручную сделать тоже самое, хоят технически эти команды должны отрабатывать корректно.
### Миграции
Миграции генерируются алембиком, после установки и инициализации алембик... команда для инициализации следующая:
``` bash
alembic init alembic
```
Alembic создаст несколько файлов. Их надо настроить, т.е. прописать пути до БД. Также нужео импортировать модели для того чтобы скрипт алембика их нашел и смог сгенерировать миграциии.
Сгенерировать миграцию БД:
``` bash
alembic revision --message="Initial" --autogenerate
```
Применить сгенерированную миграцию:
``` bash 
alembic upgrade head
```
### Регистрация 
* Впервые в системе применен подход пошаговой регистрации. Реализовано на JS. 
* Так же там же реализован подход проверки полей на уникальность значений емайл и ника, запросы выполняются также JS'ом на сервер асинхронно.
* Была попытка создать поле загрузки аватара пользователя перетаскиванием. Скрипт создан, но от него потом отказался, т.к. хотел на время иметь более простой вариант загрузки файла.
* Подготовил функции модели для добавления нового пользователя.
* Подготовил функцию обработки и сохранения изображения на сервере.
* Для работы с формой я задействовал библиотеку Flask-WTF.
* Дело в том, что пользователей много, а место на диске надо экономить, значит надо все загружаемые картинки обрабатывать, обрезать под необходимый размер. И сжимать до формата WEBP, после этого только сохранять на сервере. Поэтому новый алгоритм занимается обработкой изображения при помощи библиотеки `cv2`
### Профиль пользователя
???
### Загрузка видео
* JS отображает статус загрузки файла что будет полезно при загрузки больших файлов видео
Пока что на данном этапе скрипт обрабатывает только MP4 файлы, но в дальнейшем планируется добавить и другие форматы, как только будет готов полный алгоритм от загрузки на сервер до обработки и вывода файла в потоке на странице браузера.
* Принято решение использовать библиотеку Celery. С ее помощью, загруженный во временную директорию на сервер файл, будет обработан и его данные будут занесены в БД. Это необходимо так как файлы видео большие и тяжелые, могут обрабатываться длительное время, поэтому нужно освободить сайт от этого и возложить эту задачу на обработкув отдельном потоке, а пользователю отобразить текущий статус.
### Celery 
``` bash 
celery -A run_celery worker -B
```